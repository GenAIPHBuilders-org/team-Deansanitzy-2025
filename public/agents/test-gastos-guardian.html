<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Gastos Guardian AI Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .results {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #4CAF50;
        }
        .warning {
            color: #ffa726;
        }
    </style>
</head>
<body>
    <h1>üß™ Gastos Guardian AI Integration Test</h1>
    
    <div class="test-section">
        <h2>Authentication Status</h2>
        <button onclick="checkAuth()">Check Authentication</button>
        <div id="auth-results" class="results"></div>
    </div>

    <div class="test-section">
        <h2>Direct Data Loading Test</h2>
        <button onclick="testDirectDataLoad()">Test Direct Data Load</button>
        <div id="data-results" class="results"></div>
    </div>

    <div class="test-section">
        <h2>Gastos Guardian AI Debug</h2>
        <button onclick="debugGastosGuardian()">Debug Gastos Guardian</button>
        <button onclick="refreshGastosGuardian()">Refresh Gastos Guardian</button>
        <div id="guardian-results" class="results"></div>
    </div>

    <div class="test-section">
        <h2>Manual Account Query</h2>
        <button onclick="queryAccounts()">Query User Accounts</button>
        <button onclick="queryTransactions()">Query User Transactions</button>
        <div id="query-results" class="results"></div>
    </div>

    <!-- Firebase and other imports -->
    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getUserBankAccounts, getUserTransactions } from "../js/firestoredb.js";
        import { firebaseConfig } from "../js/config.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        let currentUser = null;

        // Wait for auth state
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log('‚úÖ User authenticated:', user.uid);
                document.getElementById('auth-results').textContent = `‚úÖ Authenticated as: ${user.email} (${user.uid})`;
                document.getElementById('auth-results').className = 'results success';
            } else {
                console.log('‚ùå User not authenticated');
                document.getElementById('auth-results').textContent = '‚ùå Not authenticated';
                document.getElementById('auth-results').className = 'results error';
            }
        });

        // Expose functions globally
        window.checkAuth = function() {
            const results = document.getElementById('auth-results');
            if (currentUser) {
                results.textContent = `‚úÖ Authenticated as: ${currentUser.email}\nUID: ${currentUser.uid}`;
                results.className = 'results success';
            } else {
                results.textContent = '‚ùå Not authenticated';
                results.className = 'results error';
            }
        };

        window.testDirectDataLoad = async function() {
            const results = document.getElementById('data-results');
            results.textContent = 'Loading...';
            
            if (!currentUser) {
                results.textContent = '‚ùå No user authenticated';
                results.className = 'results error';
                return;
            }

            try {
                console.log('üîç Testing direct data load...');
                
                // Test accounts
                console.log('üìû Calling getUserBankAccounts...');
                const accounts = await getUserBankAccounts(currentUser.uid);
                console.log('üìä Accounts result:', accounts);
                
                // Test transactions
                console.log('üìû Calling getUserTransactions...');
                const transactions = await getUserTransactions(currentUser.uid);
                console.log('üìä Transactions result:', transactions);
                
                const resultText = `‚úÖ Direct Data Load Results:
                
Accounts: ${accounts?.length || 0} found
${accounts?.length > 0 ? 'Sample account: ' + JSON.stringify(accounts[0], null, 2) : 'No accounts found'}

Transactions: ${transactions?.length || 0} found
${transactions?.length > 0 ? 'Sample transaction: ' + JSON.stringify(transactions[0], null, 2) : 'No transactions found'}

Has Real Data: ${(accounts?.length > 0) || (transactions?.length > 0)}`;
                
                results.textContent = resultText;
                results.className = 'results success';
                
            } catch (error) {
                console.error('‚ùå Direct data load error:', error);
                results.textContent = `‚ùå Error: ${error.message}\n\nStack: ${error.stack}`;
                results.className = 'results error';
            }
        };

        window.debugGastosGuardian = async function() {
            const results = document.getElementById('guardian-results');
            results.textContent = 'Running debug...';
            
            try {
                if (window.debugGastosGuardian) {
                    const debugResult = await window.debugGastosGuardian();
                    results.textContent = `üîç Gastos Guardian Debug Results:
                    
${JSON.stringify(debugResult, null, 2)}`;
                    results.className = 'results success';
                } else {
                    results.textContent = '‚ùå Gastos Guardian debug function not available';
                    results.className = 'results error';
                }
            } catch (error) {
                results.textContent = `‚ùå Debug error: ${error.message}`;
                results.className = 'results error';
            }
        };

        window.refreshGastosGuardian = async function() {
            const results = document.getElementById('guardian-results');
            results.textContent = 'Refreshing...';
            
            try {
                if (window.refreshGastosGuardian) {
                    const refreshResult = await window.refreshGastosGuardian();
                    results.textContent = `üîÑ Gastos Guardian Refresh Results:
                    
${JSON.stringify(refreshResult, null, 2)}`;
                    results.className = 'results success';
                } else {
                    results.textContent = '‚ùå Gastos Guardian refresh function not available';
                    results.className = 'results error';
                }
            } catch (error) {
                results.textContent = `‚ùå Refresh error: ${error.message}`;
                results.className = 'results error';
            }
        };

        window.queryAccounts = async function() {
            const results = document.getElementById('query-results');
            results.textContent = 'Querying accounts...';
            
            if (!currentUser) {
                results.textContent = '‚ùå No user authenticated';
                results.className = 'results error';
                return;
            }

            try {
                const accounts = await getUserBankAccounts(currentUser.uid);
                results.textContent = `üìä Accounts Query Results:
                
Count: ${accounts?.length || 0}
Data: ${JSON.stringify(accounts, null, 2)}`;
                results.className = 'results success';
            } catch (error) {
                results.textContent = `‚ùå Query error: ${error.message}`;
                results.className = 'results error';
            }
        };

        window.queryTransactions = async function() {
            const results = document.getElementById('query-results');
            results.textContent = 'Querying transactions...';
            
            if (!currentUser) {
                results.textContent = '‚ùå No user authenticated';
                results.className = 'results error';
                return;
            }

            try {
                const transactions = await getUserTransactions(currentUser.uid);
                results.textContent = `üìä Transactions Query Results:
                
Count: ${transactions?.length || 0}
Data: ${JSON.stringify(transactions, null, 2)}`;
                results.className = 'results success';
            } catch (error) {
                results.textContent = `‚ùå Query error: ${error.message}`;
                results.className = 'results error';
            }
        };
    </script>
</body>
</html> 
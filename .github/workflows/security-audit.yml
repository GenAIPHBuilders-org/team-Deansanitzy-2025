name: Security Audit

on:
  # Run on every push to main branch
  push:
    branches: [ main, master ]
  
  # Run on every pull request
  pull_request:
    branches: [ main, master ]
  
  # Run weekly on Mondays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  security-audit:
    name: Security Audit & Dependency Check
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.19.2, 22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run security audit
      run: |
        echo "🔍 Running npm audit..."
        npm audit --audit-level=moderate || true
        
    - name: Check for outdated packages
      run: |
        echo "📅 Checking for outdated packages..."
        npm outdated || true
        
    - name: Run custom security scanner
      run: |
        echo "🔒 Running custom security scanner..."
        npm run security-scan || true
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report-node-${{ matrix.node-version }}
        path: security-report.json
        retention-days: 30
        
    - name: Check for critical vulnerabilities
      run: |
        echo "🚨 Checking for critical vulnerabilities..."
        AUDIT_OUTPUT=$(npm audit --audit-level=critical --json || true)
        if echo "$AUDIT_OUTPUT" | grep -q '"total":' && echo "$AUDIT_OUTPUT" | grep -v '"total": 0'; then
          echo "CRITICAL vulnerabilities found!"
          npm audit --audit-level=critical || true
          exit 1
        else
          echo "No critical vulnerabilities found."
        fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: high
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC
        
  auto-fix:
    name: Auto-fix Security Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.2'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run auto-fix
      run: |
        echo "🔧 Running automatic security fixes..."
        npm audit fix || true
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Pull Request
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'fix: automated security dependency updates'
        title: '🔒 Automated Security Dependency Updates'
        body: |
          ## 🔒 Automated Security Updates
          
          This PR contains automated security fixes for npm dependencies.
          
          ### Changes Made:
          - Updated vulnerable dependencies
          - Applied npm audit fixes
          - Resolved security vulnerabilities
          
          ### Security Scan Results:
          Please review the security report artifact for detailed information.
          
          ### Testing:
          - [ ] Verify application starts correctly
          - [ ] Test critical functionality
          - [ ] Review security report
          
          **This PR was automatically generated by the Security Audit workflow.**
        branch: security/automated-updates
        delete-branch: true
        
  notify-security-issues:
    name: Notify Security Issues
    runs-on: ubuntu-latest
    needs: [security-audit]
    if: failure() && (github.event_name == 'push' || github.event_name == 'schedule')
    
    steps:
    - name: Send notification
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          🚨 Security vulnerabilities detected in ${{ github.repository }}!
          
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          
          Please review and fix immediately.
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: env.SLACK_WEBHOOK_URL != ''

  update-security-docs:
    name: Update Security Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.2'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate security documentation
      run: |
        echo "📚 Generating security documentation..."
        
        # Create security status badge
        AUDIT_RESULT=$(npm audit --audit-level=moderate --json || true)
        VULN_COUNT=$(echo "$AUDIT_RESULT" | grep -o '"total":[0-9]*' | head -1 | cut -d':' -f2 || echo "0")
        
        if [ "$VULN_COUNT" -eq 0 ]; then
          BADGE_COLOR="brightgreen"
          BADGE_MESSAGE="secure"
        elif [ "$VULN_COUNT" -lt 5 ]; then
          BADGE_COLOR="yellow"
          BADGE_MESSAGE="$VULN_COUNT vulnerabilities"
        else
          BADGE_COLOR="red"
          BADGE_MESSAGE="$VULN_COUNT vulnerabilities"
        fi
        
        echo "Security status: $BADGE_MESSAGE ($VULN_COUNT vulnerabilities)"
        
        # Update README with security badge (if README exists)
        if [ -f "README.md" ]; then
          echo "Updating README.md with security badge..."
        fi
        
    - name: Commit documentation updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "docs: update security documentation [skip ci]"
          git push
        fi 
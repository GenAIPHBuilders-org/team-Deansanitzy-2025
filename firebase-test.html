<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Transaction Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üî• Firebase Transaction Test</h1>
    
    <div class="test-section">
        <h2>üö® FIREBASE RULES STATUS CHECK</h2>
        <p>This will check if your Firebase Console rules are properly updated.</p>
        <button onclick="checkFirebaseRules()">Check Firebase Rules</button>
        <div id="rulesResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 1: Store Transaction in Firestore</h2>
        <button onclick="testStoreTransaction()">Store Test Transaction</button>
        <div id="storeResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Retrieve Transactions from Firestore</h2>
        <button onclick="testGetTransactions()">Get All Transactions</button>
        <div id="getResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Console Logs:</h2>
        <pre id="consoleLogs"></pre>
    </div>

    <script type="module">
        import { storeTransaction, getUserTransactions } from './public/js/firestoredb.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
        import { firebaseConfig } from "./public/js/config.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Override console.log to show in HTML
        const originalLog = console.log;
        const originalError = console.error;
        const logs = [];
        
        function addLog(type, ...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            logs.push(`[${type.toUpperCase()}] ${new Date().toLocaleTimeString()}: ${message}`);
            document.getElementById('consoleLogs').textContent = logs.join('\n');
            
            if (type === 'log') originalLog(...args);
            if (type === 'error') originalError(...args);
        }
        
        console.log = (...args) => addLog('log', ...args);
        console.error = (...args) => addLog('error', ...args);

        // Test Firebase Rules directly
        window.checkFirebaseRules = async function() {
            const resultDiv = document.getElementById('rulesResult');
            resultDiv.innerHTML = '<p>üîç Testing Firebase Rules...</p>';
            
            try {
                console.log('üß™ Testing direct Firestore write access...');
                
                // Try to write directly to Firestore without authentication
                const testDocRef = doc(db, "users", "test-user", "transactions", `rules_test_${Date.now()}`);
                
                const testData = {
                    name: 'Rules Test Transaction',
                    amount: 99.99,
                    type: 'expense',
                    userId: 'test-user',
                    timestamp: new Date().toISOString(),
                    date: new Date().toISOString().split('T')[0]
                };
                
                await setDoc(testDocRef, testData);
                
                resultDiv.innerHTML = `<p class="success">‚úÖ SUCCESS: Firebase Rules are OPEN - Direct write worked!</p>
                                     <p>Your Firebase Console rules are properly updated.</p>`;
                console.log('‚úÖ Firebase rules test passed: Direct write successful');
                
            } catch (error) {
                console.error('‚ùå Firebase rules test failed:', error);
                
                if (error.code === 'permission-denied') {
                    resultDiv.innerHTML = `<p class="error">‚ùå FAILED: Firebase Rules are NOT updated!</p>
                                         <p class="warning">‚ö†Ô∏è Your local firestore.rules file is different from Firebase Console.</p>
                                         <p><strong>Fix:</strong> Go to <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> ‚Üí Your Project ‚Üí Firestore Database ‚Üí Rules</p>
                                         <p>Replace rules with:</p>
                                         <pre>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</pre>
                                         <p>Then click <strong>PUBLISH</strong>!</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>
                                         <pre>Code: ${error.code || 'N/A'}</pre>`;
                }
            }
        };

        // Test functions
        window.testStoreTransaction = async function() {
            const resultDiv = document.getElementById('storeResult');
            resultDiv.innerHTML = '<p>Testing...</p>';
            
            try {
                console.log('üß™ Starting transaction storage test...');
                
                const testTransaction = {
                    id: `test_${Date.now()}`,
                    name: 'Test Transaction',
                    amount: 100.50,
                    type: 'expense',
                    category: 'Food',
                    date: new Date().toISOString().split('T')[0],
                    description: 'Firebase test transaction'
                };
                
                console.log('Test transaction data:', testTransaction);
                
                const result = await storeTransaction('test-user', testTransaction);
                
                if (result) {
                    resultDiv.innerHTML = `<p class="success">‚úÖ SUCCESS: Transaction stored successfully!</p>
                                         <pre>${JSON.stringify(testTransaction, null, 2)}</pre>`;
                    console.log('‚úÖ Test passed: Transaction stored successfully');
                } else {
                    resultDiv.innerHTML = '<p class="error">‚ùå FAILED: Function returned false</p>';
                    console.error('‚ùå Test failed: Function returned false');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>
                                     <pre>Code: ${error.code || 'N/A'}
Name: ${error.name || 'N/A'}
Message: ${error.message}</pre>`;
                console.error('‚ùå Test failed with error:', error);
            }
        };

        window.testGetTransactions = async function() {
            const resultDiv = document.getElementById('getResult');
            resultDiv.innerHTML = '<p>Testing...</p>';
            
            try {
                console.log('üß™ Starting transaction retrieval test...');
                
                const transactions = await getUserTransactions('test-user');
                
                if (Array.isArray(transactions)) {
                    resultDiv.innerHTML = `<p class="success">‚úÖ SUCCESS: Retrieved ${transactions.length} transactions</p>
                                         <pre>${JSON.stringify(transactions, null, 2)}</pre>`;
                    console.log(`‚úÖ Test passed: Retrieved ${transactions.length} transactions`);
                } else {
                    resultDiv.innerHTML = '<p class="error">‚ùå FAILED: Did not return an array</p>';
                    console.error('‚ùå Test failed: Did not return an array');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>
                                     <pre>Code: ${error.code || 'N/A'}
Name: ${error.name || 'N/A'}
Message: ${error.message}</pre>`;
                console.error('‚ùå Test failed with error:', error);
            }
        };
        
        console.log('üî• Firebase Transaction Test page loaded');
    </script>
</body>
</html> 